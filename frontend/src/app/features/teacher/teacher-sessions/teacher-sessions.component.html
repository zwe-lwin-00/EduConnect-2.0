<div class="page-block">
  <header class="page-header">
    <h1>Sessions</h1>
    <dx-button text="Start 1:1 session" type="default" (onClick)="openStart()"></dx-button>
  </header>
  <div class="toolbar">
    <label>From</label>
    <dx-date-box [value]="from" (valueChange)="from = $event; load()" type="date"></dx-date-box>
    <label>To</label>
    <dx-date-box [value]="to" (valueChange)="to = $event; load()" type="date"></dx-date-box>
  </div>
  <dx-toast [visible]="!!error" type="error" [message]="error" [displayTime]="6000" (onHidden)="error = ''" [position]="{ at: { x: 'center', y: 'top' }, my: { x: 'center', y: 'top' } }"></dx-toast>
  <dx-load-panel [visible]="loading" [showIndicator]="true" [showPane]="true" [shading]="false" message="Loading…"></dx-load-panel>
  <div *ngIf="!loading && !error && !sessions.length" class="empty-state">
    <p>No sessions in this date range.</p>
    <dx-button text="Start 1:1 session" type="default" (onClick)="openStart()"></dx-button>
  </div>
  <dx-data-grid *ngIf="!loading && !error && sessions.length" [dataSource]="sessions" [showBorders]="true" keyExpr="id">
    <dxi-column dataField="sessionDate" caption="Date" dataType="date"></dxi-column>
    <dxi-column caption="Type" [calculateCellValue]="typeCell"></dxi-column>
    <dxi-column caption="Student / Class" [calculateCellValue]="studentDisplayCell"></dxi-column>
    <dxi-column dataField="checkInAt" caption="Check-in"></dxi-column>
    <dxi-column dataField="checkOutAt" caption="Check-out"></dxi-column>
    <dxi-column dataField="lessonNotes" caption="Notes" [visible]="false"></dxi-column>
    <dxi-column caption="Zoom" width="150" [calculateCellValue]="zoomCell" cellTemplate="zoomCellTemplate"></dxi-column>
    <div *dxTemplate="let cell of 'zoomCellTemplate'">
      <a *ngIf="cell.value" [href]="cell.value" target="_blank" rel="noopener" class="zoom-join-link">Join Zoom meeting</a>
      <span *ngIf="!cell.value">—</span>
    </div>
    <dxi-column type="buttons" width="220" caption="Actions">
      <dxi-button hint="Check in" (onClick)="checkIn($any($event).row.data)"></dxi-button>
      <dxi-button hint="Check out" (onClick)="checkOut($any($event).row.data)"></dxi-button>
      <dxi-button hint="Notes" (onClick)="openNotes($any($event).row.data)"></dxi-button>
    </dxi-column>
  </dx-data-grid>
</div>
<dx-popup [(visible)]="showStart" title="Start 1:1 session" [showCloseButton]="true" [width]="420" (onHiding)="closeStart()">
  <div class="popup-form">
    <div class="form-item">
      <label>Contract (student)</label>
      <dx-select-box [dataSource]="contracts" displayExpr="studentName" valueExpr="id" [(value)]="startContractId" placeholder="— Select contract (student) —"></dx-select-box>
    </div>
    <div class="form-item">
      <label>Date</label>
      <dx-date-box [value]="startDate" (valueChange)="startDate = $event" type="date"></dx-date-box>
    </div>
    <div class="popup-actions">
      <dx-button text="Start" type="default" (onClick)="submitStart()"></dx-button>
      <dx-button text="Cancel" type="normal" (onClick)="closeStart()"></dx-button>
    </div>
  </div>
</dx-popup>
<dx-popup [(visible)]="showNotes" title="Lesson notes" [showCloseButton]="true" [width]="480" (onHiding)="closeNotes()">
  <div class="popup-form">
    <div class="form-item">
      <label>Notes</label>
      <dx-text-area [(value)]="lessonNotes" [height]="120"></dx-text-area>
    </div>
    <div class="popup-actions">
      <dx-button text="Save" type="default" (onClick)="saveNotes()"></dx-button>
      <dx-button text="Cancel" type="normal" (onClick)="closeNotes()"></dx-button>
    </div>
  </div>
</dx-popup>
