<div class="page-block">
  <header class="page-header">
    <h1>Homework & Grades</h1>
    <div class="header-actions">
      <dx-button text="Assign homework" type="default" (onClick)="openHomeworkForm()"></dx-button>
      <dx-button text="Add grade" type="normal" stylingMode="outlined" (onClick)="openGradeForm()"></dx-button>
    </div>
  </header>
  <h2>Homework</h2>
  <dx-toast [visible]="!!error" type="error" [message]="error" [displayTime]="6000" (onHidden)="error = ''" [position]="{ at: { x: 'center', y: 'top' }, my: { x: 'center', y: 'top' } }"></dx-toast>
  <dx-load-panel [visible]="loading" [showIndicator]="true" [showPane]="true" [shading]="false" message="Loading…"></dx-load-panel>
  <div *ngIf="!loading && !error && !homework.length" class="empty-state">
    <p>No homework yet.</p>
    <dx-button text="Assign homework" type="default" (onClick)="openHomeworkForm()"></dx-button>
  </div>
  <dx-data-grid *ngIf="!loading && !error && homework.length" [dataSource]="homework" [showBorders]="true" keyExpr="id">
    <dxi-column dataField="studentName" caption="Student"></dxi-column>
    <dxi-column dataField="title" caption="Title"></dxi-column>
    <dxi-column dataField="dueDate" caption="Due" dataType="date"></dxi-column>
    <dxi-column dataField="status" caption="Status"></dxi-column>
    <dxi-column type="buttons" width="180">
      <dxi-button hint="Mark submitted" (onClick)="markSubmitted($any($event).row.data)"></dxi-button>
      <dxi-button hint="Grade / Feedback" (onClick)="openFeedback($any($event).row.data)"></dxi-button>
    </dxi-column>
  </dx-data-grid>
  <h2>Grades</h2>
  <div *ngIf="!loading && !error && !grades.length" class="empty-state small">
    <p>No grades yet.</p>
  </div>
  <dx-data-grid *ngIf="!loading && grades.length" [dataSource]="grades" [showBorders]="true" keyExpr="id">
    <dxi-column dataField="studentName" caption="Student"></dxi-column>
    <dxi-column dataField="title" caption="Title"></dxi-column>
    <dxi-column dataField="gradeValue" caption="Score" dataType="number"></dxi-column>
    <dxi-column dataField="maxValue" caption="Max" dataType="number"></dxi-column>
    <dxi-column dataField="gradeDate" caption="Date" dataType="date"></dxi-column>
  </dx-data-grid>
</div>
<dx-popup [(visible)]="showHomeworkForm" title="Assign homework" [showCloseButton]="true" [width]="420" (onHiding)="closeHomeworkForm()">
  <div class="popup-form">
    <div class="form-item">
      <label>Student</label>
      <dx-select-box [dataSource]="students" displayExpr="fullName" valueExpr="id" [(value)]="homeworkForm.studentId" placeholder="— Select student —"></dx-select-box>
    </div>
    <div class="form-item">
      <label>Title</label>
      <dx-text-box [(value)]="homeworkForm.title"></dx-text-box>
    </div>
    <div class="form-item">
      <label>Description</label>
      <dx-text-box [(value)]="homeworkForm.description"></dx-text-box>
    </div>
    <div class="form-item">
      <label>Due date</label>
      <dx-date-box [value]="$any(homeworkForm.dueDate)" (valueChange)="homeworkForm.dueDate = $event" type="date"></dx-date-box>
    </div>
    <div class="popup-actions">
      <dx-button text="Assign" type="default" (onClick)="submitHomework()"></dx-button>
      <dx-button text="Cancel" type="normal" (onClick)="closeHomeworkForm()"></dx-button>
    </div>
  </div>
</dx-popup>
<dx-popup [(visible)]="showGradeForm" title="Add grade" [showCloseButton]="true" [width]="420" (onHiding)="closeGradeForm()">
  <div class="popup-form">
    <div class="form-item">
      <label>Student</label>
      <dx-select-box [dataSource]="students" displayExpr="fullName" valueExpr="id" [(value)]="gradeForm.studentId" placeholder="— Select student —"></dx-select-box>
    </div>
    <div class="form-item">
      <label>Title</label>
      <dx-text-box [(value)]="gradeForm.title"></dx-text-box>
    </div>
    <div class="form-item">
      <label>Score</label>
      <dx-number-box [(value)]="gradeForm.gradeValue"></dx-number-box>
    </div>
    <div class="form-item">
      <label>Max</label>
      <dx-number-box [(value)]="gradeForm.maxValue"></dx-number-box>
    </div>
    <div class="form-item">
      <label>Date</label>
      <dx-date-box [value]="$any(gradeForm.gradeDate)" (valueChange)="gradeForm.gradeDate = $event" type="date"></dx-date-box>
    </div>
    <div class="form-item">
      <label>Notes</label>
      <dx-text-box [(value)]="gradeForm.notes"></dx-text-box>
    </div>
    <div class="popup-actions">
      <dx-button text="Add" type="default" (onClick)="submitGrade()"></dx-button>
      <dx-button text="Cancel" type="normal" (onClick)="closeGradeForm()"></dx-button>
    </div>
  </div>
</dx-popup>
<dx-popup [(visible)]="showFeedback" [title]="'Grade / Feedback: ' + (selectedHomework?.title || '')" [showCloseButton]="true" [width]="480" (onHiding)="closeFeedback()">
  <div class="popup-form" *ngIf="selectedHomework">
    <div class="form-item">
      <label>Feedback</label>
      <dx-text-area [(value)]="teacherFeedback" [height]="120"></dx-text-area>
    </div>
    <div class="popup-actions">
      <dx-button text="Save (mark graded)" type="default" (onClick)="saveFeedback()"></dx-button>
      <dx-button text="Cancel" type="normal" (onClick)="closeFeedback()"></dx-button>
    </div>
  </div>
</dx-popup>
