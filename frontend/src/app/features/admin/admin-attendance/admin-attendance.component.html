<div class="page-block">
  <header class="page-header">
    <h1>Attendance</h1>
  </header>
  <p class="hint">Teachers check in/out from Sessions. Use Override to correct times, hours, or notes.</p>
  <dx-toast [visible]="!!error" type="error" [message]="error" [displayTime]="6000" (onHidden)="error = ''" [position]="{ at: { x: 'center', y: 'top' }, my: { x: 'center', y: 'top' } }"></dx-toast>
  <div class="toolbar">
    <label>Date</label>
    <dx-date-box [(value)]="date" type="date" (onValueChanged)="onDateChange()"></dx-date-box>
  </div>
  <dx-load-panel [visible]="loading" [showIndicator]="true" [showPane]="true" [shading]="false" message="Loading…"></dx-load-panel>
  <div *ngIf="!loading && !error && !list.length" class="empty-state">
    <p>No attendance records for this date.</p>
  </div>
  <dx-data-grid *ngIf="!loading && !error && list.length" [dataSource]="list" [showBorders]="true" keyExpr="id">
    <dxi-column dataField="sessionDate" caption="Date" dataType="date"></dxi-column>
    <dxi-column dataField="teacherName" caption="Teacher"></dxi-column>
    <dxi-column dataField="studentName" caption="Student"></dxi-column>
    <dxi-column dataField="checkInAt" caption="Check-in"></dxi-column>
    <dxi-column dataField="checkOutAt" caption="Check-out"></dxi-column>
    <dxi-column dataField="hoursUsed" caption="Hours" dataType="number"></dxi-column>
    <dxi-column dataField="lessonNotes" caption="Notes"></dxi-column>
    <dxi-column type="buttons" width="90">
      <dxi-button hint="Override" (onClick)="openOverride($any($event).row.data)"></dxi-button>
    </dxi-column>
  </dx-data-grid>
</div>
<dx-popup [(visible)]="showOverride" title="Override check-in / check-out" [showCloseButton]="true" [width]="480" (onHiding)="closeOverride()">
  <div class="popup-form" *ngIf="selected">
    <p class="session-info">{{ selected.teacherName }} – {{ selected.studentName }} ({{ selected.sessionDate }}) · Check-in: {{ selected.checkInAt | myanmarDate:'short' }} · Check-out: {{ selected.checkOutAt | myanmarDate:'short' }}</p>
    <div class="form-item">
      <label>Check-in</label>
      <dx-date-box [value]="$any(overrideForm.checkInAt)" (valueChange)="overrideForm.checkInAt = $event" type="datetime"></dx-date-box>
    </div>
    <div class="form-item">
      <label>Check-out</label>
      <dx-date-box [value]="$any(overrideForm.checkOutAt)" (valueChange)="overrideForm.checkOutAt = $event" type="datetime"></dx-date-box>
    </div>
    <div class="form-item">
      <label>Hours used</label>
      <dx-number-box [value]="$any(overrideForm.hoursUsed)" (valueChange)="overrideForm.hoursUsed = $event" [min]="0" [step]="0.25"></dx-number-box>
    </div>
    <div class="form-item">
      <label>Lesson notes</label>
      <dx-text-area [(value)]="overrideForm.lessonNotes" [height]="80"></dx-text-area>
    </div>
    <div class="popup-actions">
      <dx-button text="Save" type="default" (onClick)="saveOverride()"></dx-button>
      <dx-button text="Cancel" type="normal" (onClick)="closeOverride()"></dx-button>
    </div>
  </div>
</dx-popup>
